{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-end mb-3">
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
  </div>
<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- Sidebar for additional features -->
    <div class="col-md-3 col-lg-2 d-none d-md-block bg-light border-end">
      <div class="sidebar-sticky pt-3">
        <!-- User Info -->
        <div class="text-center mb-4">
          <div class="avatar-lg bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2">
            <i class="bi bi-robot text-white fs-3"></i>
          </div>
          <h6 class="fw-bold mb-1">StudyBot Assistant</h6>
          <small class="text-muted">Always ready to help</small>
        </div>

        <!-- Quick Actions -->
        <div class="mb-4">
          <h6 class="text-uppercase small fw-bold text-muted mb-3">Quick Actions</h6>
          <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action border-0 py-2 quick-prompt" data-prompt="Can you explain this concept?">
              <i class="bi bi-lightbulb me-2 text-warning"></i>Explain Concept
            </button>
            <button class="list-group-item list-group-item-action border-0 py-2 quick-prompt" data-prompt="Help me solve this problem step by step">
              <i class="bi bi-calculator me-2 text-info"></i>Solve Problem
            </button>
            <button class="list-group-item list-group-item-action border-0 py-2 quick-prompt" data-prompt="Summarize the key points">
              <i class="bi bi-file-text me-2 text-success"></i>Summarize
            </button>
            <button class="list-group-item list-group-item-action border-0 py-2 quick-prompt" data-prompt="Give me study tips for this topic">
              <i class="bi bi-book me-2 text-primary"></i>Study Tips
            </button>
          </div>
        </div>

        <!-- Chat History -->
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-uppercase small fw-bold text-muted mb-0">Recent Chats</h6>
            <button class="btn btn-sm btn-outline-secondary" id="clearHistory">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div id="chatHistory" class="list-group list-group-flush small">
            <!-- Chat history will be populated here -->
          </div>
        </div>

        <!-- Status -->
        <div class="mt-auto p-2 border-top">
          <div class="d-flex align-items-center">
            <div class="status-indicator bg-success rounded-circle me-2"></div>
            <small class="text-muted">Online</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9 col-lg-10 d-flex flex-column" style="height: calc(100vh - 120px);">
      <!-- Chat Header -->
      <div class="chat-header bg-white border-bottom py-3 px-4">
        <div class="d-flex align-items-center">
          <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
            <i class="bi bi-robot text-white"></i>
          </div>
          <div>
            <h5 class="mb-0 fw-bold">StudyBot Assistant</h5>
            <small class="text-muted" id="botStatus">Typing...</small>
          </div>
          <div class="ms-auto">
            <button class="btn btn-sm btn-outline-secondary me-2" id="toggleSidebar">
              <i class="bi bi-layout-sidebar"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" id="newChat">
              <i class="bi bi-plus-circle"></i> New Chat
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chat" class="chat-window flex-grow-1 p-4">
        <!-- Welcome Message -->
        <div class="welcome-message text-center mb-4">
          <div class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3">
            <i class="bi bi-robot text-primary fs-1"></i>
          </div>
          <h4 class="fw-bold text-dark mb-2">Hello, I'm StudyBot! ðŸ‘‹</h4>
          <p class="text-muted mb-4">I'm here to help with your studies. Ask me anything about your coursework!</p>
          
          <!-- Quick Start Cards -->
          <div class="row g-3 justify-content-center">
            <div class="col-md-3">
              <div class="card quick-start-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                  <i class="bi bi-lightbulb text-warning fs-2 mb-2"></i>
                  <h6 class="fw-bold">Explain Concepts</h6>
                  <small class="text-muted">Get clear explanations</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card quick-start-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                  <i class="bi bi-calculator text-info fs-2 mb-2"></i>
                  <h6 class="fw-bold">Solve Problems</h6>
                  <small class="text-muted">Step-by-step solutions</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card quick-start-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                  <i class="bi bi-file-text text-success fs-2 mb-2"></i>
                  <h6 class="fw-bold">Summarize</h6>
                  <small class="text-muted">Key points extraction</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input bg-light border-top p-3">
        <div class="input-group input-group-lg">
          <span class="input-group-text bg-white border-end-0">
            <i class="bi bi-emoji-smile text-muted"></i>
          </span>
          <input 
            id="msg" 
            type="text" 
            class="form-control border-start-0 border-end-0" 
            placeholder="Ask the student bot anything..." 
            aria-label="Type your message"
          >
          <button class="btn btn-outline-secondary border-start-0" type="button" id="attachFile">
            <i class="bi bi-paperclip"></i>
          </button>
          <button class="btn btn-primary px-4" type="button" onclick="sendMsg()" id="sendButton">
            <i class="bi bi-send-fill"></i>
            <span class="d-none d-sm-inline ms-1">Send</span>
          </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions mt-2 d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-secondary quick-prompt" data-prompt="Can you explain this in simpler terms?">
            <i class="bi bi-translate me-1"></i>Simplify
          </button>
          <button class="btn btn-sm btn-outline-secondary quick-prompt" data-prompt="Give me examples of this concept">
            <i class="bi bi-collection me-1"></i>Examples
          </button>
          <button class="btn btn-sm btn-outline-secondary quick-prompt" data-prompt="What are the key points to remember?">
            <i class="bi bi-bookmark me-1"></i>Key Points
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Typing Indicator Template -->
<template id="typingIndicator">
  <div class="message bot-message typing-indicator">
    <div class="message-avatar">
      <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center">
        <i class="bi bi-robot text-white small"></i>
      </div>
    </div>
    <div class="message-content">
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
</template>

<style>
:root {
  --primary-color: #4361ee;
  --secondary-color: #3f37c9;
  --user-bubble: #4361ee;
  --bot-bubble: #f8f9fa;
  --success-color: #28a745;
  --warning-color: #ffc107;
  --danger-color: #dc3545;
}

body {
  background-color: #f8f9fa;
}

.chat-wrap {
  height: calc(100vh - 120px);
  display: flex;
  flex-direction: column;
}

/* Sidebar Styles */
.sidebar-sticky {
  height: calc(100vh - 120px);
  display: flex;
  flex-direction: column;
}

.avatar-lg {
  width: 80px;
  height: 80px;
}

.avatar-sm {
  width: 40px;
  height: 40px;
}

.status-indicator {
  width: 8px;
  height: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Chat Window Styles */
.chat-window {
  overflow-y: auto;
  background: linear-gradient(135deg, #f5f7fb 0%, #e4edf5 100%);
  scroll-behavior: smooth;
}

/* Message Styles */
.message {
  display: flex;
  margin-bottom: 1.5rem;
  animation: messageSlide 0.3s ease-out;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.user-message {
  flex-direction: row-reverse;
}

.bot-message {
  flex-direction: row;
}

.message-avatar {
  flex-shrink: 0;
  margin: 0 0.75rem;
}

.message-content {
  max-width: 70%;
  position: relative;
}

.user-message .message-content {
  background: linear-gradient(135deg, var(--user-bubble), var(--secondary-color));
  color: white;
  border-radius: 1.5rem 1.5rem 0.25rem 1.5rem;
  padding: 1rem 1.25rem;
  box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.bot-message .message-content {
  background: white;
  color: #333;
  border-radius: 1.5rem 1.5rem 1.5rem 0.25rem;
  padding: 1rem 1.25rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  border: 1px solid #e9ecef;
}

/* Typing Indicator */
.typing-indicator .message-content {
  background: white;
  border-radius: 1.5rem 1.5rem 1.5rem 0.25rem;
  padding: 1rem 1.25rem;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #6c757d;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

/* Welcome Message */
.welcome-message {
  animation: fadeIn 1s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.quick-start-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  cursor: pointer;
}

.quick-start-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
}

/* Chat Input */
.chat-input {
  background: white !important;
  border-top: 1px solid #e9ecef !important;
}

.input-group:focus-within {
  box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
  border-radius: 0.75rem;
}

#msg {
  border-radius: 0;
  padding: 0.75rem 1rem;
  font-size: 1rem;
}

#msg:focus {
  box-shadow: none;
  border-color: #dee2e6;
}

/* Quick Actions */
.quick-actions .btn {
  border-radius: 1.5rem;
  font-size: 0.875rem;
  transition: all 0.3s ease;
}

.quick-actions .btn:hover {
  transform: translateY(-2px);
}

/* Scrollbar Styling */
.chat-window::-webkit-scrollbar {
  width: 6px;
}

.chat-window::-webkit-scrollbar-track {
  background: transparent;
}

.chat-window::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 3px;
}

.chat-window::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}

/* Responsive Design */
@media (max-width: 768px) {
  .message-content {
    max-width: 85%;
  }
  
  .sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    height: 100vh;
    z-index: 1000;
    transition: left 0.3s ease;
  }
  
  .sidebar.show {
    left: 0;
  }
  
  .chat-header {
    padding: 1rem;
  }
  
  .welcome-message .row {
    flex-direction: column;
  }
  
  .welcome-message .col-md-3 {
    margin-bottom: 1rem;
  }
}

/* Message Timestamp */
.message-time {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-top: 0.25rem;
}

/* Loading States */
.btn-loading {
  position: relative;
  color: transparent !important;
}

.btn-loading::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
let isTyping = false;
let currentChatId = Date.now().toString();

document.addEventListener('DOMContentLoaded', function() {
  // Enter key to send message
  document.getElementById('msg').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMsg();
    }
  });

  // Quick prompt buttons
  document.querySelectorAll('.quick-prompt').forEach(button => {
    button.addEventListener('click', function() {
      const prompt = this.getAttribute('data-prompt');
      document.getElementById('msg').value = prompt;
      sendMsg();
    });
  });

  // Quick start cards
  document.querySelectorAll('.quick-start-card').forEach(card => {
    card.addEventListener('click', function() {
      const text = this.querySelector('h6').textContent;
      document.getElementById('msg').value = `Can you help me with ${text.toLowerCase()}?`;
      sendMsg();
    });
  });

  // New chat button
  document.getElementById('newChat').addEventListener('click', function() {
    if (confirm('Start a new chat? Current conversation will be saved.')) {
      clearChat();
      currentChatId = Date.now().toString();
      saveChatHistory();
    }
  });

  // Clear history
  document.getElementById('clearHistory').addEventListener('click', function() {
    if (confirm('Clear all chat history?')) {
      localStorage.removeItem('chatHistory');
      updateChatHistory();
    }
  });

  // Toggle sidebar on mobile
  document.getElementById('toggleSidebar').addEventListener('click', function() {
    document.querySelector('.sidebar').classList.toggle('show');
  });

  // Load chat history
  updateChatHistory();
  loadChatHistory();
});

async function sendMsg() {
  const input = document.getElementById('msg');
  const text = input.value.trim();
  if (!text) return;

  // Add user message
  addBubble(text, 'user');
  input.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  // Disable send button
  const sendButton = document.getElementById('sendButton');
  sendButton.disabled = true;
  sendButton.classList.add('btn-loading');

  try {
    const res = await fetch("{{ url_for('chat_send') }}", {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: text, chat_id: currentChatId})
    });
    
    const j = await res.json();
    
    // Hide typing indicator
    hideTypingIndicator();
    
    if (j.ok) {
      addBubble(j.reply, 'bot');
    } else {
      addBubble("Error: " + (j.reply || "unknown"), 'bot');
    }
  } catch(err) {
    hideTypingIndicator();
    addBubble("Server error: " + err.message, 'bot');
  } finally {
    // Re-enable send button
    sendButton.disabled = false;
    sendButton.classList.remove('btn-loading');
  }

  // Save to history
  saveChatHistory();
}

function addBubble(text, who) {
  const chat = document.getElementById('chat');
  
  // Remove welcome message if it's the first user message
  const welcomeMessage = chat.querySelector('.welcome-message');
  if (welcomeMessage && who === 'user') {
    welcomeMessage.remove();
  }

  const messageEl = document.createElement('div');
  messageEl.className = `message ${who}-message`;
  
  const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  messageEl.innerHTML = `
    <div class="message-avatar">
      <div class="avatar-sm ${who === 'user' ? 'bg-success' : 'bg-primary'} rounded-circle d-flex align-items-center justify-content-center">
        <i class="bi bi-${who === 'user' ? 'person' : 'robot'} text-white small"></i>
      </div>
    </div>
    <div class="message-content">
      <div class="message-text">${escapeHtml(text)}</div>
      <div class="message-time text-end">${timestamp}</div>
    </div>
  `;
  
  chat.appendChild(messageEl);
  chat.scrollTop = chat.scrollHeight;
}

function showTypingIndicator() {
  const chat = document.getElementById('chat');
  const template = document.getElementById('typingIndicator');
  const indicator = template.content.cloneNode(true);
  chat.appendChild(indicator);
  chat.scrollTop = chat.scrollHeight;
  isTyping = true;
}

function hideTypingIndicator() {
  const chat = document.getElementById('chat');
  const indicator = chat.querySelector('.typing-indicator');
  if (indicator) {
    indicator.remove();
  }
  isTyping = false;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function saveChatHistory() {
  const chat = document.getElementById('chat');
  const messages = chat.querySelectorAll('.message');
  if (messages.length > 0) {
    const history = Array.from(messages).map(msg => ({
      text: msg.querySelector('.message-text').textContent,
      who: msg.classList.contains('user-message') ? 'user' : 'bot',
      time: msg.querySelector('.message-time').textContent
    }));
    
    const existingHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
    const chatIndex = existingHistory.findIndex(chat => chat.id === currentChatId);
    
    if (chatIndex > -1) {
      existingHistory[chatIndex].messages = history;
    } else {
      existingHistory.unshift({
        id: currentChatId,
        title: history[0].text.substring(0, 50) + (history[0].text.length > 50 ? '...' : ''),
        messages: history,
        timestamp: new Date().toISOString()
      });
      
      // Keep only last 10 chats
      if (existingHistory.length > 10) {
        existingHistory.pop();
      }
    }
    
    localStorage.setItem('chatHistory', JSON.stringify(existingHistory));
    updateChatHistory();
  }
}

function loadChatHistory() {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  const currentChat = history.find(chat => chat.id === currentChatId);
  
  if (currentChat) {
    const chat = document.getElementById('chat');
    chat.innerHTML = '';
    
    currentChat.messages.forEach(msg => {
      addBubble(msg.text, msg.who);
    });
  }
}

function updateChatHistory() {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  const historyContainer = document.getElementById('chatHistory');
  
  historyContainer.innerHTML = history.map(chat => `
    <button class="list-group-item list-group-item-action border-0 py-2" onclick="loadChat('${chat.id}')">
      <div class="d-flex w-100 justify-content-between">
        <small class="text-truncate">${escapeHtml(chat.title)}</small>
      </div>
      <small class="text-muted">${new Date(chat.timestamp).toLocaleDateString()}</small>
    </button>
  `).join('');
}

function loadChat(chatId) {
  currentChatId = chatId;
  loadChatHistory();
}

function clearChat() {
  const chat = document.getElementById('chat');
  chat.innerHTML = `
    <div class="welcome-message text-center mb-4">
      <div class="avatar-lg bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3">
        <i class="bi bi-robot text-primary fs-1"></i>
      </div>
      <h4 class="fw-bold text-dark mb-2">Hello, I'm StudyBot! ðŸ‘‹</h4>
      <p class="text-muted mb-4">I'm here to help with your studies. Ask me anything about your coursework!</p>
      
      <div class="row g-3 justify-content-center">
        <div class="col-md-3">
          <div class="card quick-start-card h-100 border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="bi bi-lightbulb text-warning fs-2 mb-2"></i>
              <h6 class="fw-bold">Explain Concepts</h6>
              <small class="text-muted">Get clear explanations</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card quick-start-card h-100 border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="bi bi-calculator text-info fs-2 mb-2"></i>
              <h6 class="fw-bold">Solve Problems</h6>
              <small class="text-muted">Step-by-step solutions</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card quick-start-card h-100 border-0 shadow-sm">
            <div class="card-body text-center">
              <i class="bi bi-file-text text-success fs-2 mb-2"></i>
              <h6 class="fw-bold">Summarize</h6>
              <small class="text-muted">Key points extraction</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Re-attach event listeners to quick start cards
  document.querySelectorAll('.quick-start-card').forEach(card => {
    card.addEventListener('click', function() {
      const text = this.querySelector('h6').textContent;
      document.getElementById('msg').value = `Can you help me with ${text.toLowerCase()}?`;
      sendMsg();
    });
  });
}
</script>
{% endblock %}